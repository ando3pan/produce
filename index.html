<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seasonal Produce Tier Carousel</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"/>
  <style>
    /* Theme variables */
    :root {
      --bg-color:      #f8f9fa;
      --fg-color:      #212529;
      --card-bg:       #ffffff;
      --nav-bg:        #ffffff;
      --border-color:  rgba(0,0,0,0.1);
    }
    body.dark {
      --bg-color:      #121212;
      --fg-color:      #e0e0e0;
      --card-bg:       #1e1e1e;
      --nav-bg:        #1b1b1b;
      --border-color:  rgba(255,255,255,0.1);
    }

    body {
      background: var(--bg-color);
      color: var(--fg-color);
      padding: 5rem 1rem 6rem; /* accommodate navbar + larger month */
      transition: background 0.3s, color 0.3s;
    }
    h2, h3 {
      transition: color 0.3s;
    }
    body.dark h2, body.dark h3 {
      color: var(--fg-color);
    }

    /* bump the top padding so nothing ever sits underneath the fixed-top navbar */
    .carousel-item h2 {
      margin-top: 1.5rem;   /* pushes ‚ÄúJuly‚Äù etc. below the navbar */
      font-size: 2rem;
      font-weight: 600;
    }

    /* search box */
    #searchBox {
      width: 100%;
      padding: .5rem .75rem;
    }

    /* Card grid */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card-cell {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 0.5rem;
    }
    .card-cell img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: .25rem;
    }
    .card-cell .name { font-weight: bold; font-size: .9rem; color: var(--fg-color); }
    .card-cell .price { flex-grow: 1; font-size: .85rem; color: var(--fg-color); }
    .card-cell .card-footer {
      border-top: 1px solid var(--border-color);
      padding-top: .25rem;
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .btn-star, .btn-alert {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0 .25rem;
      color: #bbb;
    }
    .btn-star.favorited { color: gold; }
    .btn-alert.text-warning { color: gold!important; }

    /* Navbars */
    .navbar.fixed-top, .navbar.fixed-bottom {
      background: var(--nav-bg) !important;
      box-shadow: 0 1px 4px var(--border-color) !important;
    }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="navbar navbar-light border-bottom fixed-top">
    <div class="container-fluid align-items-center">
      <!-- Logo -->
      <a class="navbar-brand p-0 me-3" href="/">
        <img src="images/logo.png" alt="Seasonal Produce" style="max-height:40px;">
      </a>
      <!-- Prev -->
      <button id="prevBtn" class="btn btn-link"><i class="bi bi-chevron-left fs-4"></i></button>
      <!-- Search -->
      <div class="flex-grow-1 mx-2">
        <input id="searchBox" class="form-control" type="search" placeholder="Search produce‚Ä¶">
      </div>
      <!-- Next -->
      <button id="nextBtn" class="btn btn-link"><i class="bi bi-chevron-right fs-4"></i></button>
      <!-- Settings -->
      <div class="dropdown">
        <button class="btn btn-link" data-bs-toggle="dropdown"><i class="bi bi-gear fs-4"></i></button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" id="toggleDark">Night Mode</a></li>
          <li><a class="dropdown-item" href="#" id="toggleStars">‚òÖ Show Favorites</a></li>
          <li><a class="dropdown-item" href="#" id="openAlertModal">üîî Alert Settings</a></li>
          <li><a class="dropdown-item" href="#" id="toggleLang">Espa√±ol</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Carousel -->
  <div id="produceCarousel" class="carousel slide">
    <div class="carousel-indicators" id="carousel-indicators"></div>
    <div class="carousel-inner" id="carousel-inner"></div>
  </div>

  <!-- Shopping List Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">My Shopping List</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="cartItems" class="list-group"></ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Settings Modal -->
  <div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Alert Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="alertEmail" class="form-label">Email for notifications</label>
            <input type="email" id="alertEmail" class="form-control" placeholder="you@example.com"/>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="globalEmailAlerts"/>
            <label class="form-check-label" for="globalEmailAlerts">
              Enable email notifications for S-tier items
            </label>
          </div>
          <small class="text-muted d-block mt-2">
            We‚Äôll only notify you when a favorited item hits S-tier.
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" id="saveAlertSettings" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navbar -->
  <nav class="navbar fixed-bottom navbar-light bg-light border-top">
    <div class="container-fluid justify-content-between">
      <button id="openList" class="btn btn-primary position-relative">
        <i class="bi bi-cart3"></i> My List
        <span id="listBadge" class="badge bg-danger position-absolute top-0 start-100 translate-middle">0</span>
      </button>
    </div>
  </nav>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize Night Mode from storage
    if (JSON.parse(localStorage.getItem('dark'))) {
      document.body.classList.add('dark');
    }

    // Data & settings
    const seasonsEN = { /* your full months data here */ };
    const seasonsES = { /* your Spanish mapping here */ };
    const tierEN = { S:"Top Picks", A:"Great Deals", B:"Okay", D:"Skip" };
    const tierES = { S:"Mejores", A:"Grandes Ofertas", B:"Aceptable", D:"Omitir" };
    const settings = {
      dark:   JSON.parse(localStorage.getItem("dark"))   || false,
      stars:  JSON.parse(localStorage.getItem("stars"))  || false,
      alerts: JSON.parse(localStorage.getItem("alerts")) || false,
      esp:    JSON.parse(localStorage.getItem("esp"))    || false
    };
    const save = key => localStorage.setItem(key, JSON.stringify(settings[key]));

    // Toggles
    document.getElementById("toggleDark").onclick = e => {
      e.preventDefault();
      document.body.classList.toggle("dark");
      settings.dark = document.body.classList.contains("dark");
      save("dark");
    };
    document.getElementById("toggleStars").onclick = e => {
      e.preventDefault();
      settings.stars = !settings.stars;
      save("stars");
      buildCarousel();
    };
    document.getElementById("openAlertModal").onclick = e => {
      e.preventDefault();
      document.getElementById("alertEmail").value = localStorage.getItem("alertEmail") || "";
      document.getElementById("globalEmailAlerts").checked = JSON.parse(localStorage.getItem("globalEmailAlerts")) || false;
      new bootstrap.Modal(document.getElementById("alertModal")).show();
    };
    document.getElementById("toggleLang").onclick = e => {
      e.preventDefault();
      settings.esp = !settings.esp;
      save("esp");
      buildCarousel();
    };

    // Helpers
    function fileNameFor(name) {
      return name.toLowerCase().replace(/ /g,'-').replace(/[^a-z-]/g,'') + '.png';
    }
    function computeTier(today,best) {
      if (today == null || best == null) return "D";
      const r = today / best;
      if (r <= 1.10) return "S";
      if (r <= 1.30) return "A";
      if (r <= 1.60) return "B";
      return "D";
    }
    const getS = k => JSON.parse(localStorage.getItem(k)) || [];
    function toggleS(k,name) {
      const arr = getS(k), idx = arr.indexOf(name);
      if (idx >= 0) arr.splice(idx,1); else arr.push(name);
      localStorage.setItem(k, JSON.stringify(arr));
      buildCarousel();
    }
    function getList() { return getS("shoppingList"); }
    function addToList(name) {
      const list = getList();
      if (!list.includes(name)) list.push(name);
      localStorage.setItem("shoppingList", JSON.stringify(list));
      updateListBadge();
    }
    function updateListBadge() {
      document.getElementById("listBadge").textContent = getList().length;
    }

    // Core: build the carousel
    async function buildCarousel() {
      document.body.classList.toggle("dark", settings.dark);
      const seasons = settings.esp ? seasonsES : seasonsEN;
      const labels  = settings.esp ? tierES     : tierEN;
      const prices  = await (await fetch("prices.json")).json();

      const ind = document.getElementById("carousel-indicators");
      const inner = document.getElementById("carousel-inner");
      ind.innerHTML = ""; inner.innerHTML = "";

      Object.keys(seasons).forEach((month,i) => {
        // Indicator
        const dot = document.createElement("button");
        dot.type = "button";
        dot.dataset.bsTarget = "#produceCarousel";
        dot.dataset.bsSlideTo = i;
        if (i === 0) dot.classList.add("active");
        dot.setAttribute("aria-label", month);
        ind.appendChild(dot);

        // Slide
        const slide = document.createElement("div");
        slide.className = "carousel-item" + (i===0 ? " active" : "");
        slide.innerHTML = `<h2>${month}</h2>`;

        // Annotate & optionally filter favorites
        let items = seasons[month].map(name => {
          const p = prices[name] || {};
          return { name, today:p.today, best:p.best, tier:computeTier(p.today,p.best) };
        });
        if (settings.stars) {
          const favs = getS("stars");
          items = items.filter(it => favs.includes(it.name));
        }

        // Bucket by tier
        const buckets = { S:[], A:[], B:[], D:[] };
        items.forEach(it => buckets[it.tier].push(it));

        // Render tiers
        ["S","A","B","D"].forEach(t => {
          const sect = document.createElement("div");
          sect.className = "tier-section";
          sect.innerHTML = `<h3>${t} ‚Äî ${labels[t]}</h3>`;
          const grid = document.createElement("div");
          grid.className = "card-grid";

          buckets[t].forEach(it => {
            const cell = document.createElement("div");
            cell.className = "card-cell";
            const fname = fileNameFor(it.name);
            const isFav = getS("stars").includes(it.name);
            const bellOk = settings.alerts && it.tier==="S";

            cell.innerHTML = `
              <img src="images/${fname}" alt="${it.name}"
                   onerror="this.onerror=null;this.src='images/placeholder.png';">
              <div class="name">${it.name}</div>
              <div class="price">${it.today!=null?`$${it.today.toFixed(2)}/lb`:"‚Äî"}</div>
              <div class="card-footer">
                <button class="btn-star${isFav?" favorited":""}"
                        data-action="star" data-name="${it.name}">‚òÖ</button>
                <button class="btn btn-sm btn-outline-success ms-1"
                        data-action="list" data-name="${it.name}">Ôºã</button>
                ${bellOk
                  ? `<button class="btn-alert${getS("alerts").includes(it.name)?" text-warning":""}"
                            data-action="alert" data-name="${it.name}">üîî</button>`
                  : ""
                }
              </div>`;
            grid.appendChild(cell);
          });

          sect.appendChild(grid);
          slide.appendChild(sect);
        });

        inner.appendChild(slide);
      });

      // Initialize carousel controls
      const carousel = new bootstrap.Carousel(
        document.getElementById("produceCarousel"),
        { interval:false, wrap:false }
      );
      document.getElementById("prevBtn").onclick = () => carousel.prev();
      document.getElementById("nextBtn").onclick = () => carousel.next();

      // Delegate clicks on cards
      inner.onclick = e => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const { action, name } = btn.dataset;
        if (action === "list")  addToList(name);
        if (action === "star")  toggleS("stars", name);
        if (action === "alert") toggleS("alerts", name);
      };

      updateListBadge();
    }

    // Save alert settings
    document.getElementById("saveAlertSettings").onclick = () => {
      const email = document.getElementById("alertEmail").value.trim();
      const on = document.getElementById("globalEmailAlerts").checked;
      localStorage.setItem("alertEmail", email);
      localStorage.setItem("globalEmailAlerts", JSON.stringify(on));
      bootstrap.Modal.getInstance(document.getElementById("alertModal")).hide();
      alert("Alert settings saved!");
    };

    // Shopping List modal
    const cartModal = new bootstrap.Modal(document.getElementById("cartModal"));
    document.getElementById("openList").onclick = () => {
      const ul = document.getElementById("cartItems"), list = getList();
      ul.innerHTML = "";
      if (!list.length) {
        ul.innerHTML = '<li class="list-group-item">Your list is empty.</li>';
      } else {
        list.forEach(item => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.textContent = item;
          const rm = document.createElement("button");
          rm.className = "btn btn-sm btn-outline-danger";
          rm.textContent = "Remove";
          rm.onclick = () => {
            const arr = getList(), idx = arr.indexOf(item);
            if (idx >= 0) {
              arr.splice(idx,1);
              localStorage.setItem("shoppingList", JSON.stringify(arr));
              updateListBadge();
              li.remove();
              if (!arr.length)
                ul.innerHTML = '<li class="list-group-item">Your list is empty.</li>';
            }
          };
          li.appendChild(rm);
          ul.appendChild(li);
        });
      }
      cartModal.show();
    };

    // Live search filter
    document.getElementById("searchBox").addEventListener("input", e => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll(".card-cell").forEach(cell => {
        cell.style.display = cell.textContent.toLowerCase().includes(q) ? "" : "none";
      });
    });

    // Initial render
    buildCarousel();
  </script>
</body>
</html>
