<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seasonal Produce Tier Carousel</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    /* Theme variables */
    :root {
      --bg-color:     #f8f9fa;
      --fg-color:     #212529;
      --card-bg:      #ffffff;
      --nav-bg:       #ffffff;
      --border-color: rgba(0,0,0,0.1);
    }
    body.dark {
      --bg-color:     #121212;
      --fg-color:     #e0e0e0;
      --card-bg:      #1e1e1e;
      --nav-bg:       #1b1b1b;
      --border-color: rgba(255,255,255,0.1);
    }

    body {
      background: var(--bg-color);
      color: var(--fg-color);
      padding: 5rem 1rem 6rem;
      transition: background .3s, color .3s;
    }
    h2, h3 { transition: color .3s; }

    /* Text in dark mode */
    body.dark .carousel-item h2,
    body.dark .carousel-item h3,
    body.dark .card-cell .name,
    body.dark .card-cell .price,
    body.dark .dropdown-item,
    body.dark .navbar .btn-link,
    body.dark .navbar-brand,
    body.dark #searchBox {
      color: var(--fg-color) !important;
    }

    /* Navbar & cards */
    .navbar.fixed-top, .navbar.fixed-bottom {
      background: var(--nav-bg) !important;
      box-shadow: 0 1px 4px var(--border-color) !important;
    }
    .card-cell {
      background: var(--card-bg);
      box-shadow: 0 1px 3px var(--border-color);
    }

    /* Month label */
    .carousel-item h2 {
      margin-top: 1.5rem;
      font-size: 2rem;
      font-weight: 600;
    }

    /* Search box */
    #searchBox {
      width: 100%;
      padding: .5rem .75rem;
    }

    /* Card grid */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card-cell {
      border-radius: 8px;
      display: flex; flex-direction: column;
      align-items: center; text-align: center;
      padding: .5rem;
    }
    .card-cell img {
      width: 48px; height: 48px;
      object-fit: cover; border-radius: 50%;
      margin-bottom: .25rem;
    }
    .card-cell .name { font-weight: bold; font-size: .9rem; }
    .card-cell .price { flex-grow: 1; font-size: .85rem; }
    .card-cell .card-footer {
      border-top: 1px solid var(--border-color);
      padding-top: .25rem;
      width: 100%; display: flex; justify-content: center;
    }
    .btn-star, .btn-alert {
      background:none; border:none;
      font-size:1.2rem; cursor:pointer;
      padding:0 .25rem; color:#bbb;
    }
    .btn-star.favorited { color: gold; }
    .btn-alert.text-warning { color: gold!important; }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="navbar navbar-light border-bottom fixed-top">
    <div class="container-fluid align-items-center">
      <a class="navbar-brand p-0 me-3" href="/">
        <img src="images/logo.png" alt="Seasonal Produce" style="max-height:40px;">
      </a>
      <button id="prevBtn" class="btn btn-link"><i class="bi bi-chevron-left fs-4"></i></button>
      <div class="flex-grow-1 mx-2">
        <input id="searchBox" class="form-control" type="search" placeholder="Search produceâ€¦">
      </div>
      <button id="nextBtn" class="btn btn-link"><i class="bi bi-chevron-right fs-4"></i></button>
      <div class="dropdown">
        <button class="btn btn-link" data-bs-toggle="dropdown"><i class="bi bi-gear fs-4"></i></button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" id="toggleDark">Night Mode</a></li>
          <li><a class="dropdown-item" href="#" id="toggleStars">â˜… Show Favorites</a></li>
          <li><a class="dropdown-item" href="#" id="openAlertModal">ðŸ”” Alert Settings</a></li>
          <li><a class="dropdown-item" href="#" id="toggleLang">EspaÃ±ol</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Carousel -->
  <div id="produceCarousel" class="carousel slide">
    <div class="carousel-indicators" id="carousel-indicators"></div>
    <div class="carousel-inner" id="carousel-inner"></div>
  </div>

  <!-- Shopping List Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">My Shopping List</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="cartItems" class="list-group"></ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Settings Modal -->
  <div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Alert Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="alertEmail" class="form-label">Email for notifications</label>
            <input type="email" id="alertEmail" class="form-control" placeholder="you@example.com"/>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="globalEmailAlerts"/>
            <label class="form-check-label" for="globalEmailAlerts">
              Enable email notifications for S-tier items
            </label>
          </div>
          <small class="text-muted d-block mt-2">
            Weâ€™ll only notify you when a favorited item hits S-tier.
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" id="saveAlertSettings" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navbar -->
  <nav class="navbar fixed-bottom navbar-light bg-light border-top">
    <div class="container-fluid justify-content-between">
      <button id="openList" class="btn btn-primary position-relative">
        <i class="bi bi-cart3"></i> My List
        <span id="listBadge" class="badge bg-danger position-absolute top-0 start-100 translate-middle">0</span>
      </button>
    </div>
  </nav>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Apply stored night-mode
    if (JSON.parse(localStorage.getItem('dark'))) document.body.classList.add('dark');

    // Full season data:
    const seasonsEN = {
      "January": ["Apples","Avocados","Bananas","Beets","Brussels Sprouts","Cabbage","Carrots","Celery","Collard Greens","Grapefruit","Kale","Kiwifruit","Leeks","Lemons","Limes","Onions","Parsnips","Pears","Potatoes","Turnips","Winter Squash"],
      "February": ["Beets","Cabbage","Carrots","Collard Greens","Grapefruit","Kale","Kiwifruit","Leeks","Lemons","Limes","Onions","Parsnips","Pears","Potatoes","Spinach","Turnips","Winter Squash"],
      "March": ["Apples","Cabbage","Carrots","Dried Beans","Herbs","Onions","Parsnips","Potatoes","Turnips","Winter Squash"],
      "April": ["Apples","Carrots","Dried Beans","Herbs","Lettuce","Onions","Parsnips","Potatoes","Radishes"],
      "May": ["Apples","Asparagus","Beet Greens","Dried Beans","Herbs","Lettuce","Onions","Potatoes","Radishes","Rhubarb","Spinach","Turnip Greens"],
      "June": ["Apples","Asparagus","Beet Greens","Beets","Broccoli","Cabbage","Dried Beans","Garlic","Herbs","Lettuce","Mustard Greens","Onions","Peas","Potatoes","Radishes","Rhubarb","Spinach","Strawberries","Summer Squash","Swiss Chard"],
      "July": ["Apples","Beet Greens","Beets","Blueberries","Broccoli","Cabbage","Carrots","Cherries","Collard Greens","Dried Beans","Garlic","Herbs","Lettuce","Mustard Greens","Onions","Peas","Peppers","Potatoes","Radishes","Raspberries","Rhubarb","Snap Beans","Spinach","Strawberries","Summer Squash","Swiss Chard","Tomatoes","Zucchini"],
      "August": ["Apples","Beet Greens","Beets","Blackberries","Blueberries","Broccoli","Cabbage","Cantaloupe","Carrots","Cauliflower","Celery","Collard Greens","Corn","Cucumbers","Eggplant","Garlic","Grapes","Herbs","Leeks","Lettuce","Mustard Greens","Onions","Peaches","Pears","Peppers","Plums","Potatoes","Radishes","Snap Beans","Spinach","Summer Squash","Swiss Chard","Tomatoes","Zucchini"],
      "September": ["Apples","Beet Greens","Beets","Blackberries","Blueberries","Broccoli","Brussels Sprouts","Cabbage","Cantaloupe","Carrots","Cauliflower","Celery","Collard Greens","Corn","Cucumbers","Eggplant","Garlic","Grapes","Herbs","Kale","Leeks","Lettuce","Mustard Greens","Onions","Peaches","Pears","Peppers","Plums","Potatoes","Pumpkins","Radishes","Raspberries","Snap Beans","Spinach","Summer Squash","Swiss Chard","Tomatoes","Zucchini"],
      "October": ["Apples","Beets","Broccoli","Brussels Sprouts","Cabbage","Carrots","Cauliflower","Celery","Collard Greens","Corn","Cucumbers","Dried Beans","Eggplant","Garlic","Grapes","Herbs","Kale","Leeks","Lettuce","Mustard Greens","Onions","Parsnips","Pears","Peppers","Potatoes","Pumpkins","Radishes","Snap Beans","Spinach","Summer Squash","Swiss Chard","Tomatoes","Turnips","Zucchini"],
      "November": ["Apples","Avocados","Bananas","Beets","Brussels Sprouts","Cabbage","Carrots","Celery","Collard Greens","Grapefruit","Kale","Kiwifruit","Leeks","Lemons","Limes","Onions","Parsnips","Pears","Potatoes","Spinach","Turnips","Winter Squash"],
      "December": ["Apples","Avocados","Bananas","Beets","Brussels Sprouts","Cabbage","Carrots","Celery","Collard Greens","Grapefruit","Kale","Kiwifruit","Leeks","Lemons","Limes","Onions","Parsnips","Pears","Potatoes","Spinach","Turnips","Winter Squash"]
    };
    const seasonsES = {
      "Enero": seasonsEN["January"],
      "Febrero": seasonsEN["February"],
      "Marzo": seasonsEN["March"],
      "Abril": seasonsEN["April"],
      "Mayo": seasonsEN["May"],
      "Junio": seasonsEN["June"],
      "Julio": seasonsEN["July"],
      "Agosto": seasonsEN["August"],
      "Septiembre": seasonsEN["September"],
      "Octubre": seasonsEN["October"],
      "Noviembre": seasonsEN["November"],
      "Diciembre": seasonsEN["December"]
    };
    const tierEN = { S:"Top Picks", A:"Great Deals", B:"Okay", D:"Skip" };
    const tierES = { S:"Mejores", A:"Grandes Ofertas", B:"Aceptable", D:"Omitir" };

    const settings = {
      dark:   JSON.parse(localStorage.getItem("dark"))   || false,
      stars:  JSON.parse(localStorage.getItem("stars"))  || false,
      alerts: JSON.parse(localStorage.getItem("alerts")) || false,
      esp:    JSON.parse(localStorage.getItem("esp"))    || false
    };
    const save = key => localStorage.setItem(key, JSON.stringify(settings[key]));

    // Toggles
    document.getElementById("toggleDark").onclick = e => {
      e.preventDefault();
      document.body.classList.toggle("dark");
      settings.dark = document.body.classList.contains("dark");
      save("dark");
    };
    document.getElementById("toggleStars").onclick = e => {
      e.preventDefault();
      settings.stars = !settings.stars; save("stars"); buildCarousel();
    };
    document.getElementById("openAlertModal").onclick = e => {
      e.preventDefault();
      document.getElementById("alertEmail").value = localStorage.getItem("alertEmail")||"";
      document.getElementById("globalEmailAlerts").checked = JSON.parse(localStorage.getItem("globalEmailAlerts"))||false;
      new bootstrap.Modal(document.getElementById("alertModal")).show();
    };
    document.getElementById("toggleLang").onclick = e => {
      e.preventDefault();
      settings.esp = !settings.esp; save("esp"); buildCarousel();
    };

    // Helpers
    function fileNameFor(name) {
      return name.toLowerCase().replace(/ /g,'-').replace(/[^a-z-]/g,'') + '.png';
    }
    function computeTier(today,best) {
      if (today==null||best==null) return "D";
      const r = today/best;
      if (r<=1.10) return "S";
      if (r<=1.30) return "A";
      if (r<=1.60) return "B";
      return "D";
    }
    const getS = k => JSON.parse(localStorage.getItem(k)) || [];
    function toggleS(k,name) {
      const arr=getS(k), i=arr.indexOf(name);
      if (i>=0) arr.splice(i,1); else arr.push(name);
      localStorage.setItem(k, JSON.stringify(arr)); buildCarousel();
    }
    function getList(){ return getS("shoppingList"); }
    function addToList(n){ const l=getList(); if(!l.includes(n))l.push(n); localStorage.setItem("shoppingList",JSON.stringify(l)); updateListBadge(); }
    function updateListBadge(){ document.getElementById("listBadge").textContent=getList().length; }

    // Build carousel
    async function buildCarousel(){
      const seasons = settings.esp ? seasonsES : seasonsEN;
      const labels = settings.esp ? tierES : tierEN;
      const prices = await (await fetch("prices.json")).json();

      const ind = document.getElementById("carousel-indicators"),
            inner = document.getElementById("carousel-inner");
      ind.innerHTML = ""; inner.innerHTML = "";

      Object.keys(seasons).forEach((month,i)=>{
        const dot = document.createElement("button");
        dot.type="button"; dot.dataset.bsTarget="#produceCarousel"; dot.dataset.bsSlideTo=i;
        if(i===0) dot.classList.add("active");
        dot.setAttribute("aria-label",month);
        ind.appendChild(dot);

        const slide = document.createElement("div");
        slide.className = "carousel-item" + (i===0?" active":"");
        slide.innerHTML = `<h2>${month}</h2>`;

        let items = seasons[month].map(name=>{
          const p = prices[name]||{};
          return { name, today:p.today, best:p.best, tier:computeTier(p.today,p.best) };
        });
        if(settings.stars){
          const favs = getS("stars");
          items = items.filter(it=>favs.includes(it.name));
        }
        const buckets = { S:[], A:[], B:[], D:[] };
        items.forEach(it=>buckets[it.tier].push(it));

        ["S","A","B","D"].forEach(t=>{
          const sect = document.createElement("div"); sect.className="tier-section";
          sect.innerHTML = `<h3>${t} â€” ${labels[t]}</h3>`;
          const grid = document.createElement("div"); grid.className="card-grid";

          buckets[t].forEach(it=>{
            const cell = document.createElement("div"); cell.className="card-cell";
            const fn = fileNameFor(it.name),
                  isFav = getS("stars").includes(it.name),
                  bellOk = settings.alerts && it.tier==="S";

            cell.innerHTML = `
              <img src="images/${fn}" alt="${it.name}"
                   onerror="this.onerror=null;this.src='images/placeholder.png';">
              <div class="name">${it.name}</div>
              <div class="price">${it.today!=null?`$${it.today.toFixed(2)}/lb`:"â€”"}</div>
              <div class="card-footer">
                <button class="btn-star${isFav?" favorited":""}" data-action="star" data-name="${it.name}">â˜…</button>
                <button class="btn btn-sm btn-outline-success ms-1" data-action="list" data-name="${it.name}">ï¼‹</button>
                ${bellOk?`<button class="btn-alert${getS("alerts").includes(it.name)?" text-warning":""}" data-action="alert" data-name="${it.name}">ðŸ””</button>`:""}
              </div>`;
            grid.appendChild(cell);
          });

          sect.appendChild(grid);
          slide.appendChild(sect);
        });

        inner.appendChild(slide);
      });

      const carousel = new bootstrap.Carousel(document.getElementById("produceCarousel"),{interval:false,wrap:false});
      document.getElementById("prevBtn").onclick = ()=>carousel.prev();
      document.getElementById("nextBtn").onclick = ()=>carousel.next();

      inner.onclick = e=>{
        const btn = e.target.closest("button[data-action]");
        if(!btn) return;
        const {action,name} = btn.dataset;
        if(action==="list") addToList(name);
        if(action==="star") toggleS("stars",name);
        if(action==="alert") toggleS("alerts",name);
      };

      updateListBadge();
    }

    // Save alerts
    document.getElementById("saveAlertSettings").onclick = ()=>{
      const email = document.getElementById("alertEmail").value.trim();
      const on    = document.getElementById("globalEmailAlerts").checked;
      localStorage.setItem("alertEmail",email);
      localStorage.setItem("globalEmailAlerts",JSON.stringify(on));
      bootstrap.Modal.getInstance(document.getElementById("alertModal")).hide();
      alert("Alert settings saved!");
    };

    // Shopping list modal
    const cartModal = new bootstrap.Modal(document.getElementById("cartModal"));
    document.getElementById("openList").onclick = ()=>{
      const ul = document.getElementById("cartItems"), list = getList();
      ul.innerHTML="";
      if(!list.length) {
        ul.innerHTML = '<li class="list-group-item">Your list is empty.</li>';
      } else {
        list.forEach(item=>{
          const li = document.createElement("li");
          li.className="list-group-item d-flex justify-content-between align-items-center";
          li.textContent=item;
          const rm = document.createElement("button");
          rm.className="btn btn-sm btn-outline-danger";
          rm.textContent="Remove";
          rm.onclick = ()=>{
            const arr=getList(), idx=arr.indexOf(item);
            if(idx>=0){arr.splice(idx,1);localStorage.setItem("shoppingList",JSON.stringify(arr));updateListBadge();li.remove();}
            if(!arr.length) ul.innerHTML = '<li class="list-group-item">Your list is empty.</li>';
          };
          li.appendChild(rm);
          ul.appendChild(li);
        });
      }
      cartModal.show();
    };

    // Live search filter
    document.getElementById("searchBox").addEventListener("input",e=>{
      const q=e.target.value.toLowerCase();
      document.querySelectorAll(".card-cell").forEach(cell=>{
        cell.style.display = cell.textContent.toLowerCase().includes(q) ? "" : "none";
      });
    });

    // Initial render
    buildCarousel();
  </script>
</body>
</html>
